<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Lookup - Surgical Command Center</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0a0e27;
        color: #fff;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2em;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      .search-box {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .search-input {
        flex: 1;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 1.1em;
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .btn {
        padding: 15px 40px;
        border: none;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #94a3b8;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 4px solid rgba(59, 130, 246, 0.1);
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .patient-data {
        display: none;
      }

      .patient-data.active {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .data-card {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 25px;
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      }

      .card-title {
        font-size: 1.3em;
        color: #3b82f6;
      }

      .info-grid {
        display: grid;
        gap: 15px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
      }

      .info-label {
        color: #94a3b8;
        font-weight: 600;
      }

      .info-value {
        color: #fff;
      }

      .ai-summary {
        grid-column: 1 / -1;
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1),
          rgba(59, 130, 246, 0.1)
        );
        border: 1px solid rgba(139, 92, 246, 0.3);
      }

      .summary-text {
        color: #e2e8f0;
        line-height: 1.8;
        white-space: pre-wrap;
      }

      .confidence-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
        margin-top: 15px;
      }

      .confidence-high {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .imaging-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .imaging-item {
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
      }

      .imaging-date {
        color: #3b82f6;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .imaging-procedure {
        color: #e2e8f0;
      }

      .action-bar {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
      }

      .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status-available {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
      }

      .status-unavailable {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }
    </style>
  </head>
  <body>
    <!-- Load centralized configuration for consistent endpoint URLs -->
    <script src="js/connection-config.js"></script>

    <div class="container">
      <div class="header">
        <h1>üîç Patient Lookup</h1>
        <p style="color: #94a3b8">
          Search by MRN or patient name to retrieve comprehensive medical data
        </p>

        <div class="search-box">
          <input
            type="text"
            class="search-input"
            id="searchInput"
            placeholder="Enter MRN or patient name..."
            onkeypress="if(event.key==='Enter') searchPatient()"
          />
          <button
            class="btn btn-primary"
            onclick="searchPatient()"
            id="searchBtn"
          >
            üîç Search Patient
          </button>
        </div>
      </div>

      <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Fetching comprehensive patient data...</p>
        <p style="font-size: 0.9em; margin-top: 10px">
          Querying Database ‚Üí Athena EMR ‚Üí UltraLinq ‚Üí AI Analysis
        </p>
      </div>

      <div class="patient-data" id="patientData">
        <!-- Demographics Card -->
        <div class="data-card">
          <div class="card-header">
            <span style="font-size: 1.5em">üë§</span>
            <h3 class="card-title">Patient Demographics</h3>
          </div>
          <div class="info-grid" id="demographicsInfo">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Health History Card -->
        <div class="data-card">
          <div class="card-header">
            <span style="font-size: 1.5em">üè•</span>
            <h3 class="card-title">Health History (Athena EMR)</h3>
            <span class="status-badge status-unavailable" id="athenaStatus"
              >Unavailable</span
            >
          </div>
          <div class="info-grid" id="healthInfo">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Imaging History Card -->
        <div class="data-card">
          <div class="card-header">
            <span style="font-size: 1.5em">üñºÔ∏è</span>
            <h3 class="card-title">Imaging Studies (UltraLinq)</h3>
            <span class="status-badge status-unavailable" id="imagingStatus"
              >Unavailable</span
            >
          </div>
          <div class="imaging-list" id="imagingList">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- AI Summary Card (Full Width) -->
        <div class="data-card ai-summary">
          <div class="card-header">
            <span style="font-size: 1.5em">ü§ñ</span>
            <h3 class="card-title">AI Clinical Summary</h3>
          </div>
          <div class="summary-text" id="aiSummary">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-bar" style="grid-column: 1 / -1">
          <button class="btn btn-primary" onclick="refreshData()">
            üîÑ Refresh Data
          </button>
          <button class="btn btn-success" onclick="startProcedure()">
            ‚úÖ Start Procedure
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentPatientData = null;

      /**
       * PATIENT DATA RETRIEVAL - COMPREHENSIVE WORKFLOW ORCHESTRATION
       * ============================================================
       *
       * INTEGRATION ARCHITECTURE:
       * ------------------------
       * This function orchestrates retrieval from multiple heterogeneous data sources:
       *
       * 1. LOCAL DATABASE (PostgreSQL):
       *    - Patient demographics (name, MRN, DOB)
       *    - Historical procedures
       *    - O(1) lookup via indexed MRN column
       *
       * 2. ATHENA EMR (External REST API):
       *    - Medical history, medications, allergies
       *    - Latency: ~500-1000ms (external network hop)
       *    - May fail if API credentials invalid or service down
       *
       * 3. ULTRALINQ (Web Scraping via Puppeteer):
       *    - Imaging studies (ultrasound, CT, MRI)
       *    - Latency: ~2-5 seconds (browser automation overhead)
       *    - Brittle - breaks if UltraLinq UI changes
       *
       * 4. DRAGON AI (Gemini API):
       *    - Clinical summary generation
       *    - Latency: ~200-500ms
       *    - Requires Gemini API key
       *
       * ERROR HANDLING PHILOSOPHY:
       * -------------------------
       * Graceful degradation: If one data source fails, we still show data from
       * successful sources. This is critical for healthcare applications where
       * partial information is better than no information.
       *
       * Example: If Athena API is down, we still display:
       * ‚úÖ Patient demographics (from local DB)
       * ‚úÖ Imaging history (from UltraLinq)
       * ‚ùå Medical history (Athena unavailable - shown with error message)
       *
       * CONFIGURATION USAGE:
       * -------------------
       * Previously: Hardcoded URL http://localhost:3001/api/workflow/patient/...
       * Now: Uses SURGICAL_CONFIG.buildApiUrl() for dynamic endpoint resolution
       *
       * Benefits:
       * - Works in development (localhost:3001)
       * - Works in production (actual domain)
       * - Works in staging (staging.hospital.com)
       */
      async function searchPatient() {
        const searchInput = document.getElementById("searchInput");
        const query = searchInput.value.trim();

        if (!query) {
          alert("Please enter a patient MRN or name");
          return;
        }

        // Show loading
        document.getElementById("loadingIndicator").classList.add("active");
        document.getElementById("patientData").classList.remove("active");
        document.getElementById("searchBtn").disabled = true;

        try {
          // Build URL using centralized configuration
          const apiUrl = window.SURGICAL_CONFIG
            ? `${window.SURGICAL_CONFIG.WORKFLOW_BASE_URL}/patient/${encodeURIComponent(query)}`
            : `http://localhost:3001/api/workflow/patient/${encodeURIComponent(query)}`;

          const response = await fetch(apiUrl);
          const result = await response.json();

          if (result.success) {
            currentPatientData = result.data;
            displayPatientData(result.data);
          } else {
            throw new Error(result.error || "Patient not found");
          }
        } catch (error) {
          console.error("Search error:", error);
          alert(
            `Error: ${error.message}\n\nMake sure:\n1. Backend is running on port 3001\n2. Patient exists in database\n3. Docker services are running`
          );
        } finally {
          document
            .getElementById("loadingIndicator")
            .classList.remove("active");
          document.getElementById("searchBtn").disabled = false;
        }
      }

      function displayPatientData(data) {
        // Show patient data section
        document.getElementById("patientData").classList.add("active");

        // Demographics
        const demographics = document.getElementById("demographicsInfo");
        demographics.innerHTML = `
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value">${data.patient.name}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">MRN</span>
                    <span class="info-value">${data.patient.mrn}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date of Birth</span>
                    <span class="info-value">${formatDate(
                      data.patient.dob
                    )}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Age</span>
                    <span class="info-value">${data.patient.age} years</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Gender</span>
                    <span class="info-value">${capitalizeFirst(
                      data.patient.gender
                    )}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value">${
                      data.patient.contact.phone || "N/A"
                    }</span>
                </div>
            `;

        // Health History (Athena)
        const athenaStatus = document.getElementById("athenaStatus");
        const healthInfo = document.getElementById("healthInfo");

        if (data.athena?.available) {
          athenaStatus.className = "status-badge status-available";
          athenaStatus.textContent = "Connected";

          const athenaData = data.athena.data;
          healthInfo.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Total Encounters</span>
                        <span class="info-value">${
                          athenaData.encounters?.length || 0
                        }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Active Medications</span>
                        <span class="info-value">${
                          athenaData.medications?.length || 0
                        }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Known Allergies</span>
                        <span class="info-value">${
                          athenaData.allergies?.length || 0
                        }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Conditions</span>
                        <span class="info-value">${
                          athenaData.conditions?.length || 0
                        }</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Updated</span>
                        <span class="info-value">${formatDate(
                          data.athena.last_updated
                        )}</span>
                    </div>
                `;
        } else {
          athenaStatus.className = "status-badge status-unavailable";
          athenaStatus.textContent = "Not Available";
          healthInfo.innerHTML = `
                    <p style="color: #94a3b8; text-align: center; padding: 20px;">
                        ${
                          data.athena?.reason || "Athena EMR data not available"
                        }
                    </p>
                `;
        }

        // Imaging History (UltraLinq)
        const imagingStatus = document.getElementById("imagingStatus");
        const imagingList = document.getElementById("imagingList");

        if (data.imaging?.available && data.imaging.count > 0) {
          imagingStatus.className = "status-badge status-available";
          imagingStatus.textContent = `${data.imaging.count} Studies`;

          imagingList.innerHTML = data.imaging.studies
            .map(
              (study) => `
                    <div class="imaging-item">
                        <div class="imaging-date">${formatDate(
                          study.date
                        )}</div>
                        <div class="imaging-procedure">${study.procedure}</div>
                        <div style="font-size: 0.85em; color: #94a3b8; margin-top: 5px;">
                            Accession: ${study.accession}
                        </div>
                    </div>
                `
            )
            .join("");
        } else {
          imagingStatus.className = "status-badge status-unavailable";
          imagingStatus.textContent = "No Studies";
          imagingList.innerHTML = `
                    <p style="color: #94a3b8; text-align: center; padding: 20px;">
                        ${data.imaging?.error || "No imaging studies found"}
                    </p>
                `;
        }

        // AI Summary
        const aiSummary = document.getElementById("aiSummary");
        if (data.ai_summary?.generated) {
          aiSummary.innerHTML = `
                    ${data.ai_summary.summary}
                    <div class="confidence-badge confidence-high">
                        AI Confidence: ${Math.round(
                          data.ai_summary.confidence * 100
                        )}%
                    </div>
                    <div style="font-size: 0.85em; color: #94a3b8; margin-top: 10px;">
                        Generated in ${Math.round(
                          data.ai_summary.processing_time
                        )}ms
                    </div>
                `;
        } else {
          aiSummary.innerHTML = `
                    <p style="color: #f59e0b;">
                        ‚ö†Ô∏è ${
                          data.ai_summary?.fallback ||
                          "AI summary generation failed"
                        }
                    </p>
                    ${
                      data.ai_summary?.error
                        ? `
                        <p style="font-size: 0.9em; color: #94a3b8; margin-top: 10px;">
                            Error: ${data.ai_summary.error}
                        </p>
                    `
                        : ""
                    }
                `;
        }

        console.log("Patient data displayed:", data);
      }

      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function capitalizeFirst(str) {
        if (!str) return "N/A";
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      /**
       * CACHE INVALIDATION - FORCING FRESH DATA RETRIEVAL
       * =================================================
       *
       * CACHING STRATEGY BACKGROUND:
       * ---------------------------
       * The backend implements a time-based cache (TTL: 5 minutes) for patient data.
       * This reduces load on external systems (Athena, UltraLinq) and improves response time.
       *
       * Cache Hit: ~50ms response (data served from memory)
       * Cache Miss: ~3-5 seconds (fetches from all sources)
       *
       * WHY CACHE INVALIDATION IS NEEDED:
       * --------------------------------
       * Medical data changes frequently:
       * - New imaging studies uploaded
       * - Medications updated in EMR
       * - Lab results become available
       *
       * Users may need latest data immediately, rather than waiting for TTL expiration.
       *
       * IMPLEMENTATION:
       * --------------
       * Two-step process:
       * 1. POST to /api/workflow/clear-cache (invalidates server-side cache)
       * 2. Re-execute search (forces fresh fetch from all data sources)
       *
       * TRADE-OFF ANALYSIS:
       * ------------------
       * Pros: Guarantees fresh data
       * Cons: Higher latency (3-5s vs 50ms), increased load on external APIs
       *
       * Best practice: Only invalidate when user explicitly requests (via Refresh button).
       * Don't auto-refresh on timer - respects external API rate limits.
       */
      async function refreshData() {
        if (!currentPatientData) return;

        // Clear server-side cache first
        try {
          const cacheUrl = window.SURGICAL_CONFIG
            ? `${window.SURGICAL_CONFIG.WORKFLOW_BASE_URL}/clear-cache`
            : "http://localhost:3001/api/workflow/clear-cache";

          await fetch(cacheUrl, {
            method: "POST",
          });
        } catch (error) {
          console.error("Cache clear error:", error);
          // Continue anyway - search will still work, just might use cached data
        }

        // Re-execute search to fetch fresh data
        document.getElementById("searchInput").value =
          currentPatientData.patient.mrn;
        searchPatient();
      }

      function startProcedure() {
        if (!currentPatientData) return;

        // Store patient data for procedure form
        sessionStorage.setItem(
          "currentPatient",
          JSON.stringify(currentPatientData)
        );

        // Redirect to main procedure interface
        window.location.href = "index.html";
      }

      /**
       * SERVICE HEALTH MONITORING - STARTUP DIAGNOSTICS
       * ===============================================
       *
       * OBSERVABILITY PATTERN: Startup Health Check
       * ------------------------------------------
       * On page load, we query all backend services to determine system readiness.
       * This follows the "fail fast" principle - detect issues before user attempts operations.
       *
       * SERVICES MONITORED:
       * ------------------
       * 1. PostgreSQL Database
       *    - Critical: Application cannot function without it
       *    - Check method: sequelize.authenticate()
       *
       * 2. Dragon AI Service
       *    - Non-critical: Fallback to manual data entry if unavailable
       *    - Check method: HTTP GET to /api/dragon/health
       *
       * 3. UltraLinq Integration
       *    - Non-critical: Can proceed without imaging data
       *    - Check method: Configuration validation (credentials present)
       *
       * 4. Athena EMR
       *    - Non-critical: Local DB has partial data
       *    - Check method: API key configuration check
       *
       * HEALTH STATUS AGGREGATION:
       * -------------------------
       * overall: "healthy" - All services operational
       * overall: "degraded" - Some services down, core functionality available
       * overall: "unavailable" - Database down, cannot proceed
       *
       * USER EXPERIENCE IMPLICATIONS:
       * ----------------------------
       * If degraded:
       * - Show warning banner: "Some services unavailable, limited functionality"
       * - Disable AI features, voice commands
       * - Still allow manual procedure documentation
       *
       * FUTURE ENHANCEMENT:
       * ------------------
       * Could display real-time status indicators in UI:
       * üü¢ Database: Online
       * üü¢ Dragon AI: Connected
       * üî¥ Athena EMR: Unavailable
       * üü° UltraLinq: Degraded
       */
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const statusUrl = window.SURGICAL_CONFIG
            ? `${window.SURGICAL_CONFIG.WORKFLOW_BASE_URL}/services/status`
            : "http://localhost:3001/api/workflow/services/status";

          const response = await fetch(statusUrl);
          const result = await response.json();

          if (result.success) {
            console.log("‚úÖ Services Status:", result.status);

            // Log detailed status for debugging
            console.table({
              Database: result.status.services.database.connected ? '‚úÖ Online' : '‚ùå Offline',
              DragonAI: result.status.services.dragon_ai.connected ? '‚úÖ Connected' : '‚ö†Ô∏è Unavailable',
              UltraLinq: result.status.services.ultralinq.configured ? '‚úÖ Configured' : '‚ö†Ô∏è Not Configured',
              Athena: result.status.services.athena.status || '‚ùå Unknown'
            });

            // Warn if system is degraded
            if (result.status.overall !== "healthy") {
              console.warn("‚ö†Ô∏è System Degraded - Some services unavailable:", result.status);

              // Could show user-facing warning here:
              // showNotification("Some services unavailable. Limited functionality.", "warning");
            }
          }
        } catch (error) {
          console.error("‚ùå Could not check services status:", error);
          console.warn("Proceeding without health check - services may be unavailable");

          // Don't block the UI - graceful degradation
          // User can still attempt operations, they'll fail with appropriate errors
        }
      });
    </script>
  </body>
</html>
