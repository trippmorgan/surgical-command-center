<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surgical Command Center</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0a0e27;
        color: #fff;
        overflow-x: hidden;
      }

      /* Animated Background */
      .bg-pattern {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 119, 198, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 80%,
            rgba(59, 130, 246, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 20%,
            rgba(139, 92, 246, 0.1) 0%,
            transparent 50%
          );
        z-index: -1;
      }

      /* Top Navigation Bar */
      .top-nav {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.5em;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-indicators {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 20px;
        font-size: 0.85em;
        transition: all 0.3s;
      }

      .status-badge:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: translateY(-2px);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-dot.active {
        background: #10b981;
      }
      .status-dot.standby {
        background: #f59e0b;
      }
      .status-dot.offline {
        background: #ef4444;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Main Container */
      .container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 30px;
      }

      /* Patient Header */
      .patient-header {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(139, 92, 246, 0.1)
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
      }

      .patient-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }

      .info-item label {
        color: #94a3b8;
        font-size: 0.85em;
        display: block;
        margin-bottom: 5px;
      }

      .info-item .value {
        font-size: 1.2em;
        font-weight: 600;
        color: #fff;
      }

      /* Main Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      /* Voice Control Panel */
      .voice-panel {
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid rgba(139, 92, 246, 0.5);
        border-radius: 16px;
        padding: 25px;
        position: relative;
        overflow: hidden;
      }

      .voice-panel::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #8b5cf6, #3b82f6);
      }

      .voice-status {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .mic-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8em;
        animation: micPulse 2s infinite;
      }

      @keyframes micPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
        }
        50% {
          box-shadow: 0 0 0 20px rgba(139, 92, 246, 0);
        }
      }

      .voice-text {
        flex: 1;
      }

      .voice-text h3 {
        margin-bottom: 5px;
        color: #8b5cf6;
      }

      .voice-text p {
        color: #94a3b8;
        font-size: 0.9em;
      }

      .transcription-box {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        padding: 20px;
        min-height: 120px;
        font-family: "Courier New", monospace;
        color: #a5b4fc;
        margin-top: 15px;
      }

      /* Data Source Widgets */
      .data-sources {
        display: grid;
        gap: 15px;
      }

      .source-widget {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
        cursor: pointer;
      }

      .source-widget:hover {
        border-color: rgba(59, 130, 246, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.2);
      }

      .source-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .source-name {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
      }

      .source-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
      }

      .icon-ultralinq {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
      }
      .icon-athena {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .icon-dragon {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }
      .icon-sql {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      .icon-mirror {
        background: linear-gradient(135deg, #ec4899, #db2777);
      }
      .icon-pacs {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
      }

      .source-status {
        font-size: 0.75em;
        padding: 4px 12px;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .source-data {
        color: #94a3b8;
        font-size: 0.9em;
      }

      /* Procedure Form Section */
      .procedure-section {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 25px;
        margin-top: 20px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      }

      .section-title {
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .tab-buttons {
        display: flex;
        gap: 10px;
      }

      .tab-btn {
        padding: 8px 20px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        color: #94a3b8;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
      }

      .tab-btn:hover,
      .tab-btn.active {
        background: rgba(59, 130, 246, 0.3);
        color: #fff;
        border-color: #3b82f6;
      }

      /* Vessel Grid */
      .vessel-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .vessel-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 18px;
        transition: all 0.3s;
      }

      .vessel-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
      }

      .vessel-card h4 {
        color: #3b82f6;
        margin-bottom: 12px;
        font-size: 1em;
      }

      .form-field {
        margin-bottom: 12px;
      }

      .form-field label {
        display: block;
        color: #94a3b8;
        font-size: 0.85em;
        margin-bottom: 5px;
      }

      select,
      input {
        width: 100%;
        padding: 10px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        color: #fff;
        font-size: 0.9em;
        transition: all 0.3s;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      select option {
        background: #0f172a;
        color: #fff;
      }

      /* Action Buttons */
      .action-bar {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(59, 130, 246, 0.3);
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: #fff;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
      }

      .btn-secondary {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .btn-secondary:hover {
        background: rgba(59, 130, 246, 0.2);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .vessel-grid {
          grid-template-columns: 1fr;
        }

        .patient-info-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="bg-pattern"></div>

    <!-- Load Configuration FIRST - Critical for proper endpoint resolution -->
    <script src="js/connection-config.js"></script>

    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="logo">
        <span>🏥</span>
        <span>Surgical Command Center</span>
      </div>
      <div class="status-indicators">
        <div class="status-badge">
          <span class="status-dot active"></span>
          <span>Dragon Active</span>
        </div>
        <div class="status-badge">
          <span class="status-dot active"></span>
          <span>6 Sources Connected</span>
        </div>
        <div class="status-badge">
          <span class="status-dot active"></span>
          <span>Database Online</span>
        </div>
        <div class="status-badge">
          <span>⚙️</span>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- Patient Header -->
      <div class="patient-header">
        <h2 style="margin-bottom: 15px">📋 Active Procedure</h2>
        <div class="patient-info-grid">
          <div class="info-item">
            <label>Patient Name</label>
            <div class="value">Jones, William R.</div>
          </div>
          <div class="info-item">
            <label>MRN</label>
            <div class="value">MRN-458932</div>
          </div>
          <div class="info-item">
            <label>DOB / Age</label>
            <div class="value">03/15/1958 (67y)</div>
          </div>
          <div class="info-item">
            <label>Procedure</label>
            <div class="value">Lower Extremity Angiogram</div>
          </div>
          <div class="info-item">
            <label>Date/Time</label>
            <div class="value">Oct 07, 2025 - 14:32</div>
          </div>
          <div class="info-item">
            <label>Surgeon</label>
            <div class="value">Dr. Morgan</div>
          </div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Voice Control Panel -->
        <div class="voice-panel">
          <div class="voice-status">
            <div class="mic-indicator">🎙️</div>
            <div class="voice-text">
              <h3>Voice Command Ready</h3>
              <p>Press <strong>R</strong> to speak - Release to process</p>
            </div>
          </div>

          <div style="margin: 20px 0">
            <h4 style="color: #94a3b8; margin-bottom: 10px">
              Last Transcription:
            </h4>
            <div class="transcription-box">
              > set procedure side to left<br />
              > set access to femoral<br />
              > set superficial femoral occlusion to 8 centimeters<br />
              > set treatment to PTA and stent
            </div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin-top: 15px;
            "
          >
            <button class="btn btn-secondary" style="justify-content: center">
              🔄 Clear Buffer
            </button>
            <button class="btn btn-secondary" style="justify-content: center">
              📝 Show Fields
            </button>
          </div>
        </div>

        <!-- Data Sources Panel -->
        <div class="data-sources">
          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-ultralinq">📊</div>
                <span>UltraLinq</span>
              </div>
              <span class="source-status">CONNECTED</span>
            </div>
            <div class="source-data">3 previous studies • Last: 2024-09-12</div>
          </div>

          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-athena">🏥</div>
                <span>Athena EMR</span>
              </div>
              <span class="source-status">CONNECTED</span>
            </div>
            <div class="source-data">
              Medical history loaded • 47 encounters
            </div>
          </div>

          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-dragon">🐉</div>
                <span>Dragon Dictation</span>
              </div>
              <span class="source-status">ACTIVE</span>
            </div>
            <div class="source-data">
              Ready for voice input • Model: small.en
            </div>
          </div>

          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-sql">🗄️</div>
                <span>Local Database</span>
              </div>
              <span class="source-status">CONNECTED</span>
            </div>
            <div class="source-data">PostgreSQL • 2,847 procedures</div>
          </div>

          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-mirror">🪞</div>
                <span>Mirror Ledger</span>
              </div>
              <span class="source-status">CONNECTED</span>
            </div>
            <div class="source-data">
              Blockchain verified • Last sync: 2 min ago
            </div>
          </div>

          <div class="source-widget">
            <div class="source-header">
              <div class="source-name">
                <div class="source-icon icon-pacs">🖼️</div>
                <span>PACS Archive</span>
              </div>
              <span class="source-status">CONNECTED</span>
            </div>
            <div class="source-data">184 imaging studies available</div>
          </div>
        </div>
      </div>

      <!-- Procedure Documentation Section -->
      <div class="procedure-section">
        <div class="section-header">
          <h3 class="section-title">
            <span>🔬</span>
            <span>Vascular Procedure Documentation</span>
          </h3>
          <div class="tab-buttons">
            <button class="tab-btn active">Vessels</button>
            <button class="tab-btn">Details</button>
            <button class="tab-btn">Imaging</button>
            <button class="tab-btn">History</button>
          </div>
        </div>

        <!-- Procedure Details Grid -->
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
          "
        >
          <div class="form-field">
            <label>Procedure Side</label>
            <select name="procedure_side">
              <option value="">Select...</option>
              <option value="left" selected>Left</option>
              <option value="right">Right</option>
              <option value="bilateral">Bilateral</option>
            </select>
          </div>
          <div class="form-field">
            <label>Access Site</label>
            <select name="access_site">
              <option value="">Select...</option>
              <option value="femoral" selected>Femoral</option>
              <option value="radial">Radial</option>
              <option value="brachial">Brachial</option>
            </select>
          </div>
          <div class="form-field">
            <label>Sheath Size</label>
            <select name="sheath_size">
              <option value="">Select...</option>
              <option value="4fr">4 Fr</option>
              <option value="5fr" selected>5 Fr</option>
              <option value="6fr">6 Fr</option>
            </select>
          </div>
          <div class="form-field">
            <label>Closure Method</label>
            <select name="closure_method">
              <option value="">Select...</option>
              <option value="mynx">Mynx</option>
              <option value="manual" selected>Manual Pressure</option>
            </select>
          </div>
        </div>

        <!-- Vessel Cards Grid -->
        <div class="vessel-grid">
          <div class="vessel-card">
            <h4>🔴 Common Iliac</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="common_iliac_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="common_iliac_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="common_iliac_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c" selected>C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟠 External Iliac</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="external_iliac_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="external_iliac_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="external_iliac_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟡 Common Femoral</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="common_femoral_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="common_femoral_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="common_femoral_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟢 Profunda Femoris</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="profunda_femoris_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="profunda_femoris_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="profunda_femoris_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🔵 Superficial Femoral</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="8 cm"
                value="8 cm"
                name="superficial_femoral_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="superficial_femoral_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent" selected>PTA + Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="superficial_femoral_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟣 Popliteal</h4>
            <div class="form-field">
              <label>Location</label>
              <select name="popliteal_location">
                <option value="">Select...</option>
                <option value="above">Above Knee</option>
                <option value="knee">At Knee</option>
                <option value="below">Below Knee</option>
              </select>
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="popliteal_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
            <div class="form-field">
              <label>TASC Classification</label>
              <select name="popliteal_tasc">
                <option value="">Select...</option>
                <option value="a">A</option>
                <option value="b">B</option>
                <option value="c">C</option>
                <option value="d">D</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🔴 Anterior Tibial</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="anterior_tibial_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="anterior_tibial_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟠 Posterior Tibial</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="posterior_tibial_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="posterior_tibial_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
          </div>

          <div class="vessel-card">
            <h4>🟡 Peroneal</h4>
            <div class="form-field">
              <label>Occlusion Length</label>
              <input
                type="text"
                placeholder="Enter length"
                name="peroneal_occlusion"
              />
            </div>
            <div class="form-field">
              <label>Treatment</label>
              <select name="peroneal_treatment">
                <option value="">Select...</option>
                <option value="pta">PTA</option>
                <option value="stent">Stent</option>
                <option value="atherectomy">Atherectomy</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
          <button class="btn btn-secondary">
            <span>💾</span>
            <span>Save Draft</span>
          </button>
          <button class="btn btn-secondary">
            <span>📄</span>
            <span>Generate Report</span>
          </button>
          <button class="btn btn-primary" onclick="saveProcedure()">
            <span>✅</span>
            <span>Complete & Save</span>
          </button>
        </div>
      </div>

      <!-- Quick Stats Footer -->
      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-top: 30px;
        "
      >
        <div
          style="
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          "
        >
          <div style="font-size: 2em; margin-bottom: 5px">⏱️</div>
          <div style="color: #94a3b8; font-size: 0.85em">Procedure Time</div>
          <div
            style="
              font-size: 1.5em;
              font-weight: 600;
              color: #3b82f6;
              margin-top: 5px;
            "
          >
            42 min
          </div>
        </div>
        <div
          style="
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          "
        >
          <div style="font-size: 2em; margin-bottom: 5px">🎙️</div>
          <div style="color: #94a3b8; font-size: 0.85em">Voice Commands</div>
          <div
            style="
              font-size: 1.5em;
              font-weight: 600;
              color: #8b5cf6;
              margin-top: 5px;
            "
          >
            24
          </div>
        </div>
        <div
          style="
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          "
        >
          <div style="font-size: 2em; margin-bottom: 5px">✅</div>
          <div style="color: #94a3b8; font-size: 0.85em">Fields Completed</div>
          <div
            style="
              font-size: 1.5em;
              font-weight: 600;
              color: #10b981;
              margin-top: 5px;
            "
          >
            12/18
          </div>
        </div>
        <div
          style="
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          "
        >
          <div style="font-size: 2em; margin-bottom: 5px">🔗</div>
          <div style="color: #94a3b8; font-size: 0.85em">Data Sources</div>
          <div
            style="
              font-size: 1.5em;
              font-weight: 600;
              color: #f59e0b;
              margin-top: 5px;
            "
          >
            6/6
          </div>
        </div>
      </div>
    </div>

    <!-- Load WebSocket Client -->
    <script src="js/websocket-client.js"></script>

    <!-- Add this script tag to your index.html, right before the closing </body> tag -->
    <!-- Place it AFTER the websocket-client.js script -->
    <script src="js/dragon-connection.js"></script>

    <script>
      // Enhanced Dragon Integration
      let dragonManager;
      let wsClient;

      /**
       * INITIALIZATION SEQUENCE - CRITICAL ORDERING
       * ==========================================
       *
       * ARCHITECTURAL PRINCIPLE: Dependency Injection via Configuration
       * --------------------------------------------------------------
       * Rather than hardcoding URLs (tight coupling), we inject configuration
       * at runtime. This follows the Dependency Inversion Principle (DIP) from SOLID.
       *
       * Benefits:
       * 1. TESTABILITY: Can inject mock endpoints for testing
       * 2. FLEXIBILITY: Same code works across dev/staging/production
       * 3. MAINTAINABILITY: Single source of truth for all endpoints
       *
       * Port Standardization (3001):
       * ---------------------------
       * Previously, the frontend had inconsistent port usage:
       * - Line 1119: ws://localhost:3000 (❌ Wrong)
       * - Line 1122: http://localhost:3000 (❌ Wrong)
       * - Server actually runs on: 3001 (✅ Correct)
       *
       * This mismatch caused connection failures manifesting as:
       * - WebSocket "Connection refused" errors
       * - Dragon health checks timing out
       * - Silent failure in network stack (no CORS errors, just dropped packets)
       *
       * Root Cause Analysis:
       * The port mismatch was a classic configuration drift issue. During development,
       * the backend port was changed from 3000 to 3001 (likely to avoid conflicts with
       * other dev servers), but frontend references weren't atomically updated.
       *
       * Solution:
       * Centralized configuration (SURGICAL_CONFIG) acts as a single source of truth.
       * All connection strings are now derived from this configuration object.
       */
      document.addEventListener("DOMContentLoaded", () => {
        // Validate configuration before proceeding
        const configValidation = window.SURGICAL_CONFIG.validate();
        if (!configValidation.valid) {
          console.error('⚠️ Configuration validation failed:', configValidation.errors);
          // Continue anyway, but log the issues for debugging
        }

        // Initialize WebSocket client with correct port (3001)
        wsClient = new SurgicalWebSocketClient(window.SURGICAL_CONFIG.WS_URL);

        // Initialize Dragon manager with centralized configuration
        dragonManager = new DragonConnectionManager(window.SURGICAL_CONFIG.BACKEND_URL);

        // Setup WebSocket callbacks
        wsClient.onConnectedCallback = () => {
          console.log("✅ Connected to backend");
          updateBackendStatus(true);
        };

        wsClient.onDisconnectedCallback = () => {
          console.log("❌ Disconnected from backend");
          updateBackendStatus(false);
        };

        wsClient.onTranscriptionCallback = (text) => {
          console.log("📝 Transcription:", text);
          updateTranscriptionDisplay(text);
        };

        // Handle Dragon processed data
        const originalHandleMessage = wsClient.handleMessage.bind(wsClient);
        wsClient.handleMessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            // Handle Dragon-specific messages
            if (data.type === "dragon_processed") {
              handleDragonProcessed(data);
            }

            if (data.type === "dragon_status") {
              updateDragonStatus(data.connected, data.details);
            }

            // Call original handler
            originalHandleMessage(event);
          } catch (error) {
            console.error("Error handling message:", error);
          }
        };

        // Connect to backend
        wsClient.connect();

        // --- Preserved functions from original script ---

        // Tab switching
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
          });
        });

        // Source widget click handlers
        document.querySelectorAll(".source-widget").forEach((widget) => {
          widget.addEventListener("click", function () {
            const sourceName =
              this.querySelector(".source-name span").textContent;
            console.log(`Opening ${sourceName} integration panel...`);
          });
        });

        // Add real-time field update listeners
        document.querySelectorAll("select, input").forEach((field) => {
          field.addEventListener("change", function () {
            const fieldName = this.name || this.id;
            const value = this.value;
            if (fieldName && value) {
              // Send update to backend
              console.log(`Field updated: ${fieldName} = ${value}`);
              wsClient.sendFieldUpdate(fieldName, value);
            }
          });
        });
      });

      function updateBackendStatus(connected) {
        const badges = document.querySelectorAll(".status-badge");
        badges.forEach((badge) => {
          if (badge.textContent.includes("Database")) {
            const dot = badge.querySelector(".status-dot");
            if (dot) {
              dot.className = connected
                ? "status-dot active"
                : "status-dot offline";
              badge.querySelector("span:last-child").textContent = connected
                ? "Database Online"
                : "Database Offline";
            }
          }
        });
      }

      function updateDragonStatus(connected, details) {
        if (dragonManager) {
          dragonManager.updateStatus(connected, { dragon_status: details });
        }
      }

      function handleDragonProcessed(data) {
        if (dragonManager) {
          dragonManager.handleDragonProcessed(data);
        }

        // Update form fields with extracted data
        if (data.fields) {
          Object.entries(data.fields).forEach(([field, fieldData]) => {
            // Check confidence if available, otherwise assume good
            const confidence =
              fieldData.confidence !== undefined ? fieldData.confidence : 1.0;
            if (confidence >= 0.7) {
              updateFormField(field, fieldData.value);
            }
          });
        }

        // Show notification
        if (data.metadata) {
          const count = Object.keys(data.fields || {}).length;
          showNotification(
            `Dragon extracted ${count} fields in ${Math.round(
              data.metadata.processing_time
            )}ms`,
            "success"
          );
        }
      }

      function updateTranscriptionDisplay(text) {
        const transcriptionBox = document.querySelector(".transcription-box");
        if (transcriptionBox) {
          const line = document.createElement("div");
          line.textContent = `> ${text}`;
          line.style.animation = "fadeIn 0.3s ease";
          transcriptionBox.appendChild(line);

          // Keep only last 10 lines
          while (transcriptionBox.children.length > 10) {
            transcriptionBox.removeChild(transcriptionBox.firstChild);
          }

          transcriptionBox.scrollTop = transcriptionBox.scrollHeight;
        }
      }

      function updateFormField(field, value) {
        const input = document.querySelector(`[name="${field}"], #${field}`);
        if (input) {
          input.value = value;

          // Highlight the field
          input.style.transition = "all 0.3s ease";
          input.style.borderColor = "#8b5cf6";
          input.style.backgroundColor = "rgba(139, 92, 246, 0.1)";

          setTimeout(() => {
            input.style.borderColor = "";
            input.style.backgroundColor = "";
          }, 2000);

          // Manually trigger the change event to notify the backend
          input.dispatchEvent(new Event("change"));
        }
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification-toast notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                max-width: 400px;
            `;

        const colors = {
          success: "linear-gradient(135deg, #10b981, #059669)",
          error: "linear-gradient(135deg, #ef4444, #dc2626)",
          warning: "linear-gradient(135deg, #f59e0b, #d97706)",
          info: "linear-gradient(135deg, #3b82f6, #2563eb)",
        };
        notification.style.background = colors[type] || colors.info;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 4000);
      }

      // Add CSS animations
      const style = document.createElement("style");
      style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateX(-10px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
      document.head.appendChild(style);

      // --- Additional Preserved Functions ---

      /**
       * PROCEDURE PERSISTENCE - DUAL-CHANNEL APPROACH
       * =============================================
       *
       * ARCHITECTURAL PATTERN: Event Sourcing with Optimistic Updates
       * ------------------------------------------------------------
       * We employ a dual-channel persistence strategy that combines:
       * 1. Real-time WebSocket broadcast (immediate UI feedback)
       * 2. RESTful API persistence (durable storage with transaction guarantees)
       *
       * Why Both Channels?
       * -----------------
       * WebSocket (Real-time channel):
       * - Purpose: Immediate state synchronization across connected clients
       * - Latency: <10ms local network
       * - Reliability: Best-effort delivery (no retry semantics)
       * - Use case: Live collaboration, immediate visual feedback
       *
       * REST API (Durable channel):
       * - Purpose: Transactional persistence to PostgreSQL
       * - Latency: ~50-100ms (includes DB write + fsync)
       * - Reliability: Request/response with explicit error handling
       * - Use case: Data durability, audit trail, recovery
       *
       * Optimistic UI Pattern:
       * ---------------------
       * We update the UI immediately via WebSocket (optimistic assumption of success),
       * while the REST API call proceeds asynchronously. If the REST call fails,
       * we compensate by showing an error and reverting the UI state.
       *
       * This provides the perception of instant response while ensuring data integrity.
       *
       * Trade-offs:
       * ----------
       * - Complexity: Must handle WebSocket success + REST failure edge case
       * - Consistency: Brief window where UI state may not match DB state
       * - Benefit: Perceived zero latency for user actions
       *
       * Alternative approaches considered:
       * - REST-only: Simpler, but UI feels sluggish (~100ms lag)
       * - WebSocket-only: Fast, but no durability guarantees
       * - CQRS: Overkill for this application's scale
       */
      function saveProcedure() {
        /**
         * DATA COLLECTION STRATEGY
         * -----------------------
         * We collect form data using querySelector with optional chaining (?.value).
         * This defensive approach prevents null reference errors if DOM elements
         * are missing (e.g., due to dynamic rendering or A/B test variants).
         *
         * Why not FormData API?
         * The native FormData API would be cleaner, but our form uses custom
         * vessel cards that aren't traditional <input> elements. Manual collection
         * gives us finer control over data transformation.
         */
        const formData = {
          patient_name: "Jones, William R.",  // TODO: Pull from session storage
          mrn: "MRN-458932",                   // TODO: Dynamic patient selection
          procedure_side: document.querySelector('[name="procedure_side"]')?.value,
          access_site: document.querySelector('[name="access_site"]')?.value,
          sheath_size: document.querySelector('[name="sheath_size"]')?.value,
          closure_method: document.querySelector('[name="closure_method"]')?.value,
          status: "completed",

          // Timestamp for audit trail
          completed_at: new Date().toISOString(),

          // Client-side validation metadata
          validation_passed: true  // TODO: Implement actual validation
        };

        /**
         * CHANNEL 1: WebSocket Real-time Broadcast
         * ----------------------------------------
         * Sends optimistic update to all connected clients.
         * No error handling needed here - fire-and-forget semantics.
         */
        if (wsClient && wsClient.connected) {
          wsClient.sendProcedureUpdate(formData);
        }

        /**
         * CHANNEL 2: REST API Durable Persistence
         * ---------------------------------------
         * POST to /api/procedures with proper error handling.
         * Uses centralized configuration for correct port (3001).
         *
         * Previously: fetch("http://localhost:3000/api/procedures") ❌ Wrong port!
         * Now: Uses SURGICAL_CONFIG.buildApiUrl() ✅ Correct!
         */
        const apiUrl = window.SURGICAL_CONFIG.buildApiUrl('/procedures');

        fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            // Check HTTP status before parsing JSON
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("✅ Procedure saved:", data);
            showNotification("Procedure saved to database!", "success");

            // Optional: Clear form or redirect to summary page
            // window.location.href = '/procedure-summary.html?id=' + data.id;
          })
          .catch((error) => {
            console.error("❌ Error saving:", error);
            showNotification(
              `Error saving procedure: ${error.message}`,
              "error"
            );

            // TODO: Implement retry logic with exponential backoff
            // TODO: Store failed request in IndexedDB for later retry
          });
      }

      // Simulate real-time updates for mic pulse
      setInterval(() => {
        const mic = document.querySelector(".mic-indicator");
        if (mic) {
          mic.style.transform = `scale(${1 + Math.random() * 0.1})`;
        }
      }, 2000);
    </script>
  </body>
</html>
